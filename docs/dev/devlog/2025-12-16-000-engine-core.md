# 2025-12-16-000: Engine Core Implementation

## Focus

Implement Hearts game engine with hypothesis testing.

## What Happened

Built core engine package with TDD approach (tests verified by intentional
breakage):

**Modules created:**

- `cards.py` - Card, Suit, Rank with sleek enum pattern (attributes + `__str__`)
- `state.py` - GameState, Phase, PassDirection, PlayerAction types
- `rules.py` - Point cards, trick winner, valid plays logic
- `engine.py` - new_game, apply_action, game flow

**Test coverage (56 tests):**

- cards_test.py (13) - deck creation, card properties, hypothesis
  equality/ordering
- rules_test.py (18) - point cards, scoring, trick winner, hypothesis invariants
- engine_test.py (25) - new game, pass phase, play phase, following suit

**Key design decisions:**

- Enums with attributes: `Suit.HEARTS.symbol` → "♥", `str(Suit.HEARTS)` → "♥"
- Tests as siblings (e.g., `cards.py` + `cards_test.py`)
- Describe/it test naming via pytest config
- Mutable GameState with `.copy()` for action application

## Decisions

- Hypothesis used for property tests, not yet for stateful game flow testing
- Phase enum tracks game state machine: PASSING → PLAYING → ROUND_END → GAME_END

## What Works

- New game creation with seeded shuffle
- Pass phase: select 3 cards, all 4 players, execute passes
- Play phase: 2♣ leads first, follow suit rules, hearts broken tracking
- Trick winner determination
- Point card identification and scoring

## What's Written But Untested

- `complete_trick` - awarding trick to winner
- `complete_round` - end of 13 tricks, scoring
- `apply_moon_choice` - shooter choosing +26 to others or -26 to self
- `check_game_end` - 100 point threshold
- `start_new_round` - deal new hands, rotate pass direction

## Next Session

1. **Write tests for round completion** (TDD - see failures first)
   - Play through full trick (4 cards → winner)
   - Play through full round (13 tricks → scoring)
   - Moon shooting detection and choice
   - Game end at 100 points

2. **Add stateful hypothesis tests**
   - Random valid action sequences
   - Verify card conservation invariant
   - Verify game always terminates

3. **Then:** CLI renderer or bot (per milestone)

## Entity Model

```
Enums: Suit, Rank, Phase, PassDirection
Value Objects: Card, Play, ActionResult
Actions: SelectPass, PlayCard, ChooseMoonOption (union: PlayerAction)
State: GameState
Type Aliases: PlayerId (Literal[0,1,2,3])
```

## Files Changed

```
packages/engine/src/hearts_engine/
├── cards.py + cards_test.py
├── rules.py + rules_test.py
├── state.py
├── engine.py + engine_test.py
└── __init__.py (unchanged, empty per convention)
pyproject.toml (added hypothesis, pytest Describe/it_ config)
```
